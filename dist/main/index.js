(()=>{"use strict";var e={16:e=>{e.exports=require("url")},194:e=>{e.exports=require("jszip")},218:function(e,t,n){var o,r=this&&this.__createBinding||(Object.create?function(e,t,n,o){void 0===o&&(o=n);var r=Object.getOwnPropertyDescriptor(t,n);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,o,r)}:function(e,t,n,o){void 0===o&&(o=n),e[o]=t[n]}),a=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),s=this&&this.__importStar||(o=function(e){return o=Object.getOwnPropertyNames||function(e){var t=[];for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[t.length]=n);return t},o(e)},function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n=o(e),s=0;s<n.length;s++)"default"!==n[s]&&r(t,e,n[s]);return a(t,e),t});Object.defineProperty(t,"__esModule",{value:!0}),t.FileServer=void 0;const i=s(n(611)),c=s(n(896)),l=s(n(928)),d=s(n(16));t.FileServer=class{constructor(){this.server=null,this.port=8888}start(e,t=8888){return this.port=t,new Promise((t,n)=>{this.server=i.createServer((t,n)=>{const o=d.parse(t.url||""),r=decodeURIComponent(o.pathname||"/"),a=l.join(e,r);if(!a.startsWith(e))return n.statusCode=403,void n.end("Forbidden");c.stat(a,(e,o)=>{if(e||!o.isFile())return n.statusCode=404,void n.end("Not found");const r={".mp4":"video/mp4",".webm":"video/webm",".mp3":"audio/mpeg",".wav":"audio/wav",".html":"text/html",".vtt":"text/vtt",".json":"application/json"}[l.extname(a).toLowerCase()]||"application/octet-stream",s=t.headers.range;if(s&&(r.startsWith("video/")||r.startsWith("audio/"))){const e=s.replace(/bytes=/,"").split("-"),t=parseInt(e[0],10),i=e[1]?parseInt(e[1],10):o.size-1,l=i-t+1;n.writeHead(206,{"Content-Range":`bytes ${t}-${i}/${o.size}`,"Accept-Ranges":"bytes","Content-Length":l,"Content-Type":r,"Access-Control-Allow-Origin":"*"}),c.createReadStream(a,{start:t,end:i}).pipe(n)}else n.writeHead(200,{"Content-Length":o.size,"Content-Type":r,"Access-Control-Allow-Origin":"*","Cache-Control":"public, max-age=3600"}),c.createReadStream(a).pipe(n)})}),this.server.listen(this.port,()=>{console.log(`File server running on http://localhost:${this.port}`),t()}),this.server.on("error",n)})}stop(){this.server&&(this.server.close(),this.server=null)}getUrl(e){return`http://localhost:${this.port}/${e}`}}},482:e=>{e.exports=require("electron")},611:e=>{e.exports=require("http")},763:function(e,t,n){var o,r=this&&this.__createBinding||(Object.create?function(e,t,n,o){void 0===o&&(o=n);var r=Object.getOwnPropertyDescriptor(t,n);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,o,r)}:function(e,t,n,o){void 0===o&&(o=n),e[o]=t[n]}),a=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),s=this&&this.__importStar||(o=function(e){return o=Object.getOwnPropertyNames||function(e){var t=[];for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[t.length]=n);return t},o(e)},function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n=o(e),s=0;s<n.length;s++)"default"!==n[s]&&r(t,e,n[s]);return a(t,e),t});Object.defineProperty(t,"__esModule",{value:!0});const i=n(482),c=s(n(928)),l=s(n(896)),d=n(797),u=n(218);let p,f,h=null;const g=process.argv.includes("--dev");function m(){h=new i.BrowserWindow({width:1600,height:900,webPreferences:{nodeIntegration:!1,contextIsolation:!0,preload:c.join(__dirname,"preload.js"),webSecurity:!g,allowRunningInsecureContent:g},backgroundColor:"#1a1a1a",titleBarStyle:"hiddenInset",show:!1}),h.once("ready-to-show",()=>{h?.show()}),h.webContents.on("crashed",(e,t)=>{console.error("[Main] Renderer process crashed!",{killed:t}),i.dialog.showErrorBox("Application Crashed","The application has crashed. Please restart.")}),h.webContents.on("unresponsive",()=>{console.error("[Main] Renderer process is unresponsive!"),1===i.dialog.showMessageBoxSync(h,{type:"warning",buttons:["Wait","Reload"],title:"Application Unresponsive",message:"The application is not responding. Would you like to wait or reload?"})&&h?.webContents.reload()}),h.webContents.on("responsive",()=>{}),h.webContents.on("render-process-gone",(e,t)=>{console.error("[Main] Render process gone!",t),i.dialog.showErrorBox("Render Process Error",`The render process has terminated: ${t.reason}`)});const e=g?"http://localhost:8080":`file://${c.join(__dirname,"../renderer/index.html")}`;h.loadURL(e),g&&h.webContents.openDevTools(),h.webContents.on("before-input-event",(e,t)=>{"F12"===t.key&&(h?.webContents.toggleDevTools(),e.preventDefault()),t.control&&t.shift&&"I"===t.key&&(h?.webContents.toggleDevTools(),e.preventDefault()),"F5"===t.key&&(h?.webContents.reload(),e.preventDefault()),t.control&&"R"===t.key&&(h?.webContents.reload(),e.preventDefault())}),h.on("closed",()=>{h=null})}i.protocol.registerSchemesAsPrivileged([{scheme:"content",privileges:{secure:!0,supportFetchAPI:!0,stream:!0,bypassCSP:!0,corsEnabled:!1}}]),i.app.whenReady().then(()=>{i.protocol.handle("content",async e=>{const t=e.url.replace("content://","");let n=decodeURIComponent(t);"win32"===process.platform&&n.startsWith("/")&&(n=n.substring(1));try{if(!l.existsSync(n))return console.error("[Protocol] File not found:",n),new Response("File not found",{status:404,statusText:"Not Found"});const t=l.statSync(n).size,o=c.extname(n).toLowerCase();let r="application/octet-stream";switch(o){case".mp4":r="video/mp4";break;case".webm":r="video/webm";break;case".ogg":case".ogv":r="video/ogg";break;case".wav":r="audio/wav";break;case".mp3":r="audio/mpeg";break;case".m4a":r="audio/mp4";break;case".vtt":r="text/vtt";break;case".html":r="text/html";break;case".css":r="text/css";break;case".js":r="application/javascript";break;case".json":r="application/json"}const a=e.headers.get("range");if(!a||".mp4"!==o&&".webm"!==o&&".mp3"!==o&&".wav"!==o&&".m4a"!==o){const e=l.readFileSync(n);".wav"===o&&(e.slice(0,4).toString("ascii"),e.slice(8,12).toString("ascii"));const a={"Content-Type":r,"Content-Length":t.toString(),"Cache-Control":"no-cache","Accept-Ranges":"bytes"};return".html"===o&&(a["X-Frame-Options"]="SAMEORIGIN",a["Content-Security-Policy"]="default-src 'self' 'unsafe-inline' 'unsafe-eval' content: file: data:; frame-ancestors 'self' content: file:;"),new Response(e,{status:200,statusText:"OK",headers:a})}{const e=function(e,t){const n=e.match(/bytes=(\d*)-(\d*)/);if(!n)return null;const o=n[1],r=n[2];let a,s;if(""===o&&""===r)return null;if(""===o){const e=parseInt(r,10);if(0===e)return null;a=Math.max(0,t-e),s=t-1}else""===r?(a=parseInt(o,10),s=t-1):(a=parseInt(o,10),s=parseInt(r,10));return a<0||s>=t||a>s?null:{start:a,end:s}}(a,t);if(!e)return new Response("Range Not Satisfiable",{status:416,statusText:"Range Not Satisfiable",headers:{"Content-Range":`bytes */${t}`}});const o=e.end-e.start+1,s=Buffer.alloc(o),i=l.openSync(n,"r");try{l.readSync(i,s,0,o,e.start)}finally{l.closeSync(i)}return new Response(s,{status:206,statusText:"Partial Content",headers:{"Content-Type":r,"Content-Length":o.toString(),"Content-Range":`bytes ${e.start}-${e.end}/${t}`,"Accept-Ranges":"bytes","Cache-Control":"no-cache"}})}}catch(e){return console.error("[Protocol] Error loading file:",e),new Response("File read error",{status:500,statusText:"Internal Server Error"})}}),p=new d.ContentLoader,f=new u.FileServer,function(){const e=[{label:"File",submenu:[{label:"Open Content Package",accelerator:"CmdOrCtrl+O",click:()=>{h?.webContents.send("menu-open-content")}},{type:"separator"},{label:"Exit",accelerator:"darwin"===process.platform?"Cmd+Q":"Ctrl+Q",click:()=>{i.app.quit()}}]},{label:"View",submenu:[{label:"Reload",accelerator:"F5",click:()=>{h?.webContents.reload()}},{label:"Force Reload",accelerator:"CmdOrCtrl+Shift+R",click:()=>{h?.webContents.reloadIgnoringCache()}},{type:"separator"},{label:"Toggle Developer Tools",accelerator:"F12",click:()=>{h?.webContents.toggleDevTools()}},{label:"Toggle Fullscreen",accelerator:"F11",click:()=>{h&&h.setFullScreen(!h.isFullScreen())}}]},{label:"Help",submenu:[{label:"About",click:()=>{i.dialog.showMessageBox(h,{type:"info",title:"About CBT Multimedia Sync",message:"CBT Multimedia Sync",detail:"Version 1.0.0\nA synchronized multimedia player for CBT content",buttons:["OK"]})}}]}],t=i.Menu.buildFromTemplate(e);i.Menu.setApplicationMenu(t)}(),m(),i.app.on("activate",()=>{0===i.BrowserWindow.getAllWindows().length&&m()})}),i.app.on("window-all-closed",()=>{"darwin"!==process.platform&&i.app.quit()}),i.ipcMain.handle("open-content-package",async()=>{const e=await i.dialog.showOpenDialog({properties:["openFile"],filters:[{name:"Content Package",extensions:["zip","pak"]},{name:"Manifest",extensions:["json"]}]});if(!e.canceled&&e.filePaths[0])try{return{success:!0,manifest:await p.loadPackage(e.filePaths[0]),basePath:c.dirname(e.filePaths[0])}}catch(e){return console.error("[Main] Error loading package:",e),{success:!1,error:e.message+"\n"+e.stack}}return{success:!1,error:"No file selected"}}),i.ipcMain.handle("load-local-manifest",async(e,t)=>{try{return{success:!0,manifest:await p.loadManifest(t),basePath:c.dirname(t)}}catch(e){return console.error("[Main] Error loading local manifest:",e),{success:!1,error:e.message}}}),i.ipcMain.handle("get-file-url",(e,t)=>{const n=t.replace(/\\/g,"/"),o=`content://${encodeURIComponent(n)}`,r=c.extname(t).toLowerCase();return[".mp4",".webm",".ogg",".ogv",".avi",".mkv",".mov"].includes(r)||[".mp3",".wav",".ogg",".oga",".m4a",".aac",".flac",".weba"].includes(r),o}),i.ipcMain.handle("get-video-url",(e,t)=>{const n=t.replace(/\\/g,"/");return`content://${encodeURIComponent(n)}`}),i.ipcMain.handle("get-audio-url",(e,t)=>{const n=t.replace(/\\/g,"/");return`content://${encodeURIComponent(n)}`})},797:function(e,t,n){var o,r=this&&this.__createBinding||(Object.create?function(e,t,n,o){void 0===o&&(o=n);var r=Object.getOwnPropertyDescriptor(t,n);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,o,r)}:function(e,t,n,o){void 0===o&&(o=n),e[o]=t[n]}),a=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),s=this&&this.__importStar||(o=function(e){return o=Object.getOwnPropertyNames||function(e){var t=[];for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[t.length]=n);return t},o(e)},function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n=o(e),s=0;s<n.length;s++)"default"!==n[s]&&r(t,e,n[s]);return a(t,e),t}),i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.ContentLoader=void 0;const c=s(n(943)),l=s(n(896)),d=s(n(928)),u=i(n(194));t.ContentLoader=class{constructor(){this.currentPackagePath=null,this.extractedPath=null}async loadPackage(e){console.log("[ContentLoader] Loading package:",e);const t=d.extname(e).toLowerCase();if(".zip"===t||".pak"===t)return this.loadZipPackage(e);if(".json"===t)return this.loadManifest(e);throw new Error(`Unsupported package format: ${t}`)}async loadZipPackage(e){console.log("[ContentLoader] Loading ZIP package:",e);try{const t=await c.readFile(e);console.log("[ContentLoader] ZIP file read, size:",t.length,"bytes");const n=await u.default.loadAsync(t);console.log("[ContentLoader] ZIP loaded, files:",Object.keys(n.files).length);const o=d.join(process.env.TEMP||"/tmp",`cbt-content-${Date.now()}`);await c.mkdir(o,{recursive:!0}),console.log("[ContentLoader] Extracting to:",o);let r=0;for(const[e,t]of Object.entries(n.files))if(!t.dir){const n=d.join(o,e),a=d.dirname(n);await c.mkdir(a,{recursive:!0});const s=await t.async("nodebuffer");await c.writeFile(n,s),r++,console.log("[ContentLoader] Extracted:",e,"("+s.length+" bytes)")}console.log("[ContentLoader] Extracted",r,"files");const a=d.join(o,"manifest.json");if(console.log("[ContentLoader] Loading manifest from:",a),!await c.access(a).then(()=>!0).catch(()=>!1))throw new Error("manifest.json not found in ZIP package");const s=await this.loadManifest(a);return console.log("[ContentLoader] Manifest loaded, duration:",s.duration_ms,"ms"),this.currentPackagePath=e,this.extractedPath=o,console.log("[ContentLoader] ZIP package loaded successfully"),s}catch(e){throw console.error("[ContentLoader] Error loading ZIP package:",e),e}}async loadManifest(e){console.log("[ContentLoader] Loading manifest:",e);const t=await c.readFile(e,"utf-8"),n=JSON.parse(t);console.log("[ContentLoader] Manifest parsed, tracks:",n.tracks.length),this.validateManifest(n);const o=d.dirname(e);return console.log("[ContentLoader] Base path for files:",o),this.updateManifestPaths(n,o),n}validateManifest(e){if(!e.version)throw new Error("Manifest missing version");if(!e.duration_ms||e.duration_ms<=0)throw new Error("Invalid duration_ms in manifest");if(!e.tracks||!Array.isArray(e.tracks))throw new Error("Manifest missing tracks array");for(const t of e.tracks){if(!t.id||!t.type||!t.items)throw new Error(`Invalid track structure: ${t.id}`);for(const e of t.items)if(!e.id||!e.file||void 0===e.start_ms)throw new Error(`Invalid item in track ${t.id}: ${e.id}`)}}updateManifestPaths(e,t){console.log("[ContentLoader] Updating manifest paths with base:",t);for(const n of e.tracks){console.log(`[ContentLoader] Processing track: ${n.type} with ${n.items.length} items`);for(const e of n.items)if(!d.isAbsolute(e.file)){const n=e.file;e.file=d.resolve(t,e.file);const o=l.existsSync(e.file);console.log(`[ContentLoader] Updated path: ${n} -> ${e.file} (exists: ${o})`),o||console.error(`[ContentLoader] WARNING: File does not exist: ${e.file}`)}}}async cleanup(){if(this.extractedPath){try{await c.rm(this.extractedPath,{recursive:!0,force:!0})}catch(e){console.error("Failed to cleanup extracted content:",e)}this.extractedPath=null}}}},896:e=>{e.exports=require("fs")},928:e=>{e.exports=require("path")},943:e=>{e.exports=require("fs/promises")}},t={};!function n(o){var r=t[o];if(void 0!==r)return r.exports;var a=t[o]={exports:{}};return e[o].call(a.exports,a,a.exports,n),a.exports}(763)})();